<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible" />
<meta content="text/html; charset=UTF-8" http-equiv="content-type" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<meta name="robots" content="index, follow">










<title>DIY UAV &#x27;Widow&#x27;</title>



<meta name="title" content="DIY UAV &#x27;Widow&#x27;">



<meta property="og:type" content="website">
<meta property="og:url" content="https://krepa098.github.io/projects/diy-uav-widow/">

<meta property="og:site_name" content="Paul&#x27;s Journal">


<meta property="og:title" content="DIY UAV &#x27;Widow&#x27;">





<link rel="canonical" href="https://krepa098.github.io/projects/diy-uav-widow/">




<link rel="stylesheet" type="text/css" href="https://speyll.github.io/suCSS/reset-min.css" />
<link rel="stylesheet" type="text/css" href="https://krepa098.github.io/css/suCSS.css" />
<link rel="stylesheet" type="text/css" href="https://krepa098.github.io/css/style.css" />
<link rel="stylesheet" type="text/css" href="https://krepa098.github.io/css/extra.css" />
<link rel="stylesheet" type="text/css" href="https://krepa098.github.io/css/gallery.css" />
<link rel="stylesheet" type='text/css' href="https://cdn.jsdelivr.net/gh/devicons/devicon@latest/devicon.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


<script src="https://krepa098.github.io/js/script.js" defer></script>
<script src="https://krepa098.github.io/js/jquery.min.js"></script>
</head>
<body>
      <header>
          

  


  <nav id="nav-bar">
    
      <a href="&#x2F;" class="">
        
        &#x2F;home&#x2F;
      </a>
    
      <a href="&#x2F;projects" class="">
        
        &#x2F;projects&#x2F;
      </a>
    
    <div>
      <input type="checkbox" id="theme-toggle" style="display: none;">
      <label for="theme-toggle" id="theme-toggle-label"><svg id="theme-icon" class="icons"><use href="https://krepa098.github.io/icons.svg#lightMode"></use></svg></label>
      <audio id="theme-sound">
        <source src="https://krepa098.github.io/click.ogg" type="audio/ogg">
      </audio>
    </div>
  </nav>


      </header>
      <main>
          
<div><a href="..">..</a>/<span class="accent-data">diy-uav-widow</span></div>
<time datetime="2019-03-01">published on: <span class="accent-data"> 03&#x2F;2019</span></time>


<div class="">
  tags:
  
  <a href="/tags/design">&#47;design&#47;</a>
  
  <a href="/tags/control">&#47;control&#47;</a>
  
  <a href="/tags/robotics">&#47;robotics&#47;</a>
  
  <a href="/tags/embedded">&#47;embedded&#47;</a>
  
</div>




<hr>
<h1>DIY UAV &#x27;Widow&#x27;</h1>















<div>
  A UAV from scratch - mechanics, electronics, firmware, and control.
</div>








<hr>



<div class="gallery-scroll-container send-back">

    <!-- scrolling container -->
    <div class="gallery-row" id="gallery-scrollbar">
        <!-- gallery elements -->
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        

        
        
        
        
        
        <div class="gallery-content-wide" id="p1">
            
            
            <img src="https:&#x2F;&#x2F;krepa098.github.io&#x2F;processed_images&#x2F;frame.d430ba802ad74b94.jpg" id="content">
            

            
            <div class="gallery-image-caption no-user-select">frame construction</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p2">
            
            
            <img src="https:&#x2F;&#x2F;krepa098.github.io&#x2F;processed_images&#x2F;pcb_v1.70712f341d51b462.jpg" id="content">
            

            
            <div class="gallery-image-caption no-user-select">assembled autopilot PCB (v1)</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p3">
            
            
            <img src="https:&#x2F;&#x2F;krepa098.github.io&#x2F;processed_images&#x2F;pcb_v2.7f0f21e0e15b42d7.jpg" id="content">
            

            
            <div class="gallery-image-caption no-user-select">assembled autopilot PCB (v2)</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p4">
            
            
            <img src="https:&#x2F;&#x2F;krepa098.github.io&#x2F;processed_images&#x2F;top.f07fa6778398d44b.jpg" id="content">
            

            
            <div class="gallery-image-caption no-user-select">top side with status LEDs, SD card, and antenna</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p5">
            
            
            <img src="https:&#x2F;&#x2F;krepa098.github.io&#x2F;processed_images&#x2F;bottom.b81cde2f33f91d4c.jpg" id="content">
            

            
            <div class="gallery-image-caption no-user-select">bottom side with ultrasonic sonar</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p6">
            
            <video id="content" autoplay loop playsinline disablePictureInPicture muted>
                <source src="https://krepa098.github.io/raw/projects/widow/flight.mp4" type="video/mp4" />
            </video>
            

            
            <div class="gallery-image-caption no-user-select">testing the stabilization</div>
            
        </div>
        
        
        
        
        
        <div class="gallery-content-wide" id="p7">
            
            <video id="content" autoplay loop playsinline disablePictureInPicture muted>
                <source src="https://krepa098.github.io/raw/projects/widow/yaw.mp4" type="video/mp4" />
            </video>
            

            
            <div class="gallery-image-caption no-user-select">testing yaw</div>
            
        </div>
        
        


        
        
        
        
        
        
        
        
    </div>

    <!-- next and previous buttons -->
    
    
    
    
    
    
    
    
    
    
    
    
    
    

    
    <a class="gallery-prev hidden-mobile">&#10094;</a>
    <a class="gallery-next hidden-mobile">&#10095;</a>
    

    
    
    
    
    
    
    
    

    <div class="gallery-popover" id="gallery-popover"></div>

    <!-- scroll script -->
    <script src="https://krepa098.github.io/js/gallery.js"></script>

</div><h3 id="description">Description</h3>
<p>The scope of this project was set as follows:</p>
<ul>
<li>design &amp; build the frame</li>
<li>design &amp; build of the flight controller electronics</li>
<li>writing the firmware required to stability the UAV and make it fly</li>
</ul>
<p>UAVs are inherently unstable systems with fast dynamics that require tight control loops to work (and yet do not require advanced control algorithms).</p>
<h4 id="frame">Frame</h4>
<p>A UAV's <a href="https://krepa098.github.io/projects/diy-uav-widow/#p1">[frame]</a> has to be lightweight and yet stiff (thus usually made out of carbon fiber).
With only limited tools at hand, the choice was made to use carbon fiber bars to tie the arms to the central hub.
Other structural parts were printed on an FDM printer with the carbon bars exopy-glued to them.
The PCBs were (ab)used as integral parts of the frame and also facilitated power distribution to the motors.</p>
<h4 id="flight-controller">Flight Controller</h4>
<p>The <a href="https://krepa098.github.io/projects/diy-uav-widow/#p2">[flight controller]</a> featured an upper and a lower PCB.
The lower PCB served as a simple power distribution board.
The upper board was dedicated to the autopilot featuring:</p>
<ul>
<li>5V <code>buck converter</code></li>
<li>3V3 LDO</li>
<li>9DOF IMU</li>
<li>Barometric pressure sensor (altitude)</li>
<li>SD card (logs)</li>
<li>3V3 to 5V level shifter</li>
<li><code>STM32F4</code> (chosen for its floating point support, running the autopilot)</li>
<li><code>ESP8266</code> (web interface), later an <code>ESP32</code></li>
</ul>
<p>Both boards were made identically apart from leaving the lower PCB unpopulated.</p>
<h4 id="firmware">Firmware</h4>
<p>The autopilot (running in the STM32F4) was written in <code>C++</code> from scratch (using a super-loop and ST's HAL) and included several interesting challenges (apart from being one of my first STM32 microcontrollers firmware <em>not</em> using the Arduino framework):</p>
<ul>
<li>a <code>DSHOT</code> (ESC signal) protocol implementation using <code>DMA</code> and <code>timers</code> to lower the load on the MCU</li>
<li>an <code>ibus</code> protocol decoder to receive the remote's stick positions</li>
<li>the communication between the STM32F4 and the ESP8266 over <code>SPI</code></li>
<li>real-time data <code>logging</code> to the SD card</li>
<li>implementing and tuning attitude and heading <code>control</code> system (cascading PID)</li>
<li><code>AHRS</code> filter implementation</li>
<li><code>FIR</code> low-pass filters to reduce the noise of the IMU measurements</li>
<li>implementing a <code>web interface</code> on the ESP8266 with settings and real-time plotting (essentially serving as a replacement for functionality typically found in QGroundControl and the like)</li>
</ul>
<p>Especially the last point was a unique and useful feature since current solutions require software to be installed that may not even be available on your platform, e.g., GCS.</p>
<h4 id="outcome">Outcome</h4>
<p>The project saw two revisions (v1 green PCB, v2 black PCB), with the latter adding support for an SD card and an altitude sensor.
The UAV was stabilizing just fine (for both) - and yet it was never really flying well.
At higher thrust levels the motor-induced vibrations were too strong and caused erratic behavior during flight (this nicely highlighted the importance of anti-vibration mounting schemes commonly observable on off-the-shelf autopilots).</p>


























      </main>
      <footer>
          <hr>
<div id="footer-container">
  
  <div>
    <p>Theme and color theme licensed under <a target="_blank" rel="noopener noreferrer"
        href="https://en.wikipedia.org/wiki/Licence_MIT">MIT</a>.<br>
      Built with <a target="_blank" rel="noopener noreferrer" href="https://www.getzola.org">Zola</a> using a fork of
      the <a target="_blank" rel="noopener noreferrer" href="https://github.com/Speyll/anemone">anemone</a> theme, <a
        target="_blank" rel="noopener noreferrer" href="https://speyll.github.io/suCSS/">suCSS</a> framework &amp; <a
        target="_blank" rel="noopener noreferrer" href="https://github.com/Speyll/veqev">veqev</a>.<br>
    </p>

  </div>
  
</div>
      </footer>
</body>
</html>